<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Gym AI | Ultimate Elite V33</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffcc33">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        :root {
            --gold: #ffcc33; --purple: #8a2be2; --neon-blue: #00f2ff;
            --danger: #ff3366; --success: #00ffaa; --bg: #050510;
            --card-bg: rgba(255, 255, 255, 0.06); --border: rgba(255, 255, 255, 0.12);
        }

        body {
            font-family: 'Cairo', sans-serif; background: var(--bg);
            background-image: radial-gradient(circle at 20% 30%, rgba(138, 43, 226, 0.15) 0%, transparent 40%);
            color: #fff; margin: 0; min-height: 100vh;
        }

        header {
            padding: 15px 5%; background: rgba(5, 5, 16, 0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }

        .p-card {
            background: var(--card-bg); backdrop-filter: blur(15px); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; margin-bottom: 20px; transition: 0.3s;
        }

        .p-input, .p-select, textarea {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            padding: 12px; border-radius: 12px; color: white; width: 100%;
            margin-bottom: 10px; font-family: 'Cairo'; outline: none; box-sizing: border-box;
        }

        .p-btn {
            background: linear-gradient(135deg, var(--gold), #ffaa00); color: #000;
            border: none; padding: 10px 18px; border-radius: 12px; font-weight: 900;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .chat-box { height: 350px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.2); border-radius: 15px; }
        .msg { padding: 12px; border-radius: 15px; max-width: 75%; position: relative; }
        .msg.cap { background: var(--card-bg); border-right: 4px solid var(--gold); align-self: flex-start; }
        .msg.user { background: var(--purple); align-self: flex-end; }
        .msg-tools { font-size: 0.7rem; margin-top: 5px; opacity: 0.5; display: flex; gap: 8px; cursor: pointer; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

        .measure-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .measure-box input { background: transparent; border: none; color: var(--gold); font-weight: 900; width: 60px; text-align: center; font-size: 1.1rem; outline: none; }
        
        .calories-badge { background: var(--gold); color: #000; padding: 5px 12px; border-radius: 10px; font-weight: bold; display: inline-block; margin-left: 10px; }
        #frozenOverlay { display:none; position:fixed; inset:0; background:rgba(5,5,16,0.97); z-index:10000; flex-direction:column; justify-content:center; align-items:center; }
        
        canvas { max-width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div class="p-card" style="width: 380px; text-align: center; border: 1px solid var(--gold);">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‘‘</div>
                <h1 style="color: var(--gold); margin: 0 0 20px 0;">POWER GYM AI</h1>
                <select id="loginRole" class="p-input">
                    <option value="user">Ø¯Ø®ÙˆÙ„ Ø¨Ø·Ù„Ø©</option>
                    <option value="admin">ÙƒØ§Ø¨ØªÙ† Ø±Ø­Ø§Ø¨ (Ø¥Ø¯Ø§Ø±Ø©)</option>
                </select>
                <input type="text" id="uInp" class="p-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="pInp" class="p-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="p-btn" style="width:100%; margin-top: 10px;" onclick="core.login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <header>
            <div id="navUserName" style="font-weight: 900; color: var(--gold);"></div>
            <button onclick="location.reload()" class="p-btn" style="background:var(--danger); color:white;">Ø®Ø±ÙˆØ¬</button>
        </header>

        <div id="frozenOverlay">
            <i class="fas fa-snowflake" style="font-size: 6rem; color: var(--neon-blue); margin-bottom: 20px;"></i>
            <h1 style="color: var(--neon-blue);">Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…Ø¯ â„ï¸</h1>
            <p>Ø±Ø§Ø¬Ø¹ÙŠ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ</p>
        </div>

        <div class="container">
            <div id="adminPanel" style="display: none;">
                <div class="grid-2">
                    <div class="p-card">
                        <h3><i class="fas fa-edit"></i> ØªØ®ØµÙŠØµ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</h3>
                        <select id="ai_target_member" class="p-input" onchange="admin.loadMemberData(this.value)"></select>
                        <div class="grid-2" style="gap:10px;">
                            <input id="adm_cal" type="number" class="p-input" placeholder="Ø§Ù„Ø³Ø¹Ø±Ø§Øª">
                            <input id="adm_pro" type="number" class="p-input" placeholder="Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†">
                        </div>
                        <textarea id="adm_breakfast" class="p-input" placeholder="Ø§Ù„ÙØ·ÙˆØ±..."></textarea>
                        <textarea id="adm_lunch" class="p-input" placeholder="Ø§Ù„ØºØ¯Ø§Ø¡..."></textarea>
                        <textarea id="adm_dinner" class="p-input" placeholder="Ø§Ù„Ø¹Ø´Ø§Ø¡..."></textarea>
                        <textarea id="adm_workout" class="p-input" placeholder="Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†..." rows="4"></textarea>
                        <input id="adm_advice" class="p-input" placeholder="Ù†ØµÙŠØ­Ø© Ø§Ù„ÙŠÙˆÙ…">
                        <button class="p-btn" style="width:100%; background:var(--purple); color:#fff;" onclick="admin.updatePlan()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</button>
                    </div>
                    <div class="p-card">
                        <h3><i class="fas fa-tasks"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ§Øª ÙˆØ§Ù„ÙˆÙ‚Øª</h3>
                        <div id="adminTable" style="max-height: 580px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div id="userPanel" style="display: none;">
                <div class="grid-2">
                    <div>
                        <div class="p-card" style="background: linear-gradient(135deg, var(--gold), #ff9900); color: #000; text-align: center;">
                            <h4 style="margin:0">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</h4>
                            <div id="u_countdown" style="font-size: 4rem; font-weight: 900;">00</div>
                            <div id="u_expiry" style="font-weight: bold; opacity: 0.8;"></div>
                        </div>

                        <div class="p-card">
                            <h3><i class="fas fa-chart-line"></i> ØªØ·ÙˆØ± Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³Ø¨Ø¹Ø©</h3>
                            <div style="margin-bottom: 15px;">
                                <div class="calories-badge">Ø³Ø¹Ø±Ø§ØªÙƒ: <span id="u_disp_cal">0</span></div>
                                <div class="calories-badge" style="background:var(--neon-blue)">Ø¨Ø±ÙˆØªÙŠÙ†: <span id="u_disp_pro">0</span> Ø¬Ù…</div>
                            </div>
                            <div class="grid-3">
                                <div class="measure-box"><small>ÙˆØ²Ù†</small><input id="m_weight" type="number"></div>
                                <div class="measure-box"><small>Ø®ØµØ±</small><input id="m_waist" type="number"></div>
                                <div class="measure-box"><small>Ø¨Ø·Ù†</small><input id="m_belly" type="number"></div>
                                <div class="measure-box"><small>Ø£Ø±Ø¯Ø§Ù</small><input id="m_hips" type="number"></div>
                                <div class="measure-box"><small>ÙØ®Ø°</small><input id="m_thigh" type="number"></div>
                                <div class="measure-box"><small>Ø°Ø±Ø§Ø¹</small><input id="m_arm" type="number"></div>
                                <div class="measure-box"><small>ØµØ¯Ø±</small><input id="m_chest" type="number"></div>
                            </div>
                            <button class="p-btn" style="width:100%; margin-top: 15px;" onclick="user.saveMeasures()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</button>
                            <canvas id="weightChart" height="150"></canvas>
                        </div>
                    </div>

                    <div>
                        <div class="p-card" style="border-right: 5px solid var(--purple);">
                            <h3 style="color:var(--purple); margin:0 0 10px 0;">Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ğŸ½ï¸</h3>
                            <div id="u_diet_data">
                                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:8px;"><b>ğŸ³ Ø§Ù„ÙØ·ÙˆØ±:</b> <span id="u_view_bf"></span></div>
                                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:8px;"><b>ğŸ— Ø§Ù„ØºØ¯Ø§Ø¡:</b> <span id="u_view_lun"></span></div>
                                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;"><b>ğŸ¥— Ø§Ù„Ø¹Ø´Ø§Ø¡:</b> <span id="u_view_din"></span></div>
                            </div>
                            <h3 style="color:var(--gold); margin:20px 0 10px 0;">Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ğŸ‹ï¸</h3>
                            <div id="u_view_work" style="white-space: pre-line; background:rgba(0,0,0,0.3); padding:12px; border-radius:10px;"></div>
                        </div>

                        <div class="p-card">
                            <div id="chatBox" class="chat-box"></div>
                            <div style="display: flex; gap: 8px; margin-top: 15px;">
                                <input id="chatInp" class="p-input" style="margin:0" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„ÙƒØ§Ø¨ØªÙ†...">
                                <button class="p-btn" onclick="chat.send()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC8qS1LqY3Q2P2LmcvM-M3lW9pNBP3o0JU",
        authDomain: "power-gym-c0a65.firebaseapp.com",
        projectId: "power-gym-c0a65",
        databaseURL: "https://power-gym-c0a65-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myChart = null;

    window.core = {
        activeId: null, role: 'user',
        login: async function() {
            const u = document.getElementById('uInp').value, p = document.getElementById('pInp').value;
            this.role = document.getElementById('loginRole').value;
            if(this.role === 'admin' && u === 'captain' && p === '123') {
                this.showUI('admin', {name:'Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø±Ø­Ø§Ø¨'});
            } else {
                const snap = await get(ref(db, 'members'));
                const m = Object.values(snap.val()||{}).find(x => x.user === u && x.pass === p);
                if(m) { this.activeId = m.id; this.showUI('user', m); } else alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
        },
        showUI: (role, data) => {
            document.getElementById('loginPage').style.display='none';
            document.getElementById('mainApp').style.display='block';
            document.getElementById('navUserName').innerText = data.name;
            if(role === 'admin') admin.init(); else user.init();
        }
    };

    window.admin = {
        init: () => {
            document.getElementById('adminPanel').style.display='block';
            onValue(ref(db, 'members'), (snap) => {
                const list = Object.values(snap.val()||{});
                const sel = document.getElementById('ai_target_member');
                const table = document.getElementById('adminTable');
                sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ù„Ø©</option>'; table.innerHTML = '';
                list.forEach(m => {
                    sel.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                    const days = Math.floor((new Date(m.expiryDate) - new Date()) / (1000*60*60*24));
                    table.innerHTML += `
                        <div class="p-card" style="margin-bottom:10px; border-right: 4px solid ${days>5?'var(--success)':'var(--danger)'}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div><b>${m.name}</b><br><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${days} ÙŠÙˆÙ…</small></div>
                                <div style="display:flex; gap:5px;">
                                    <button class="p-btn" style="padding:5px 10px; background:var(--neon-blue)" onclick="admin.freeze('${m.id}', '${m.status}')">${m.status==='frozen'?'ØªÙØ¹ÙŠÙ„':'ØªØ¬Ù…ÙŠØ¯'}</button>
                                    <button class="p-btn" style="padding:5px 10px;" onclick="admin.openChat('${m.id}')">Ø´Ø§Øª</button>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <input type="number" id="add_d_${m.id}" style="width:60px; margin:0" class="p-input" placeholder="+ ÙŠÙˆÙ…">
                                <button class="p-btn" onclick="admin.changeTime('${m.id}', 1)">+</button>
                                <button class="p-btn" style="background:var(--danger)" onclick="admin.changeTime('${m.id}', -1)">-</button>
                            </div>
                        </div>`;
                });
            });
        },
        loadMemberData: async (id) => {
            if(!id) return;
            const s = await get(ref(db, 'members/'+id));
            const d = s.val();
            ['cal','pro','breakfast','lunch','dinner','workout','advice'].forEach(k => {
                const el = document.getElementById('adm_'+k);
                if(el) el.value = d[k] || (k==='cal' || k==='pro' ? '' : '');
            });
        },
        updatePlan: async () => {
            const id = document.getElementById('ai_target_member').value;
            if(!id) return alert('Ø§Ø®ØªØ± Ø¨Ø·Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
            await update(ref(db, 'members/'+id), {
                calories: document.getElementById('adm_cal').value,
                protein: document.getElementById('adm_pro').value,
                breakfast: document.getElementById('adm_breakfast').value,
                lunch: document.getElementById('adm_lunch').value,
                dinner: document.getElementById('adm_dinner').value,
                workout: document.getElementById('adm_workout').value,
                advice: document.getElementById('adm_advice').value
            });
            alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­');
        },
        changeTime: async (id, dir) => {
            const val = parseInt(document.getElementById('add_d_'+id).value || 0) * dir;
            const s = await get(ref(db, 'members/'+id));
            let current = new Date(s.val().expiryDate);
            current.setDate(current.getDate() + val);
            await update(ref(db, 'members/'+id), { expiryDate: current.toISOString() });
        },
        freeze: async (id, curStatus) => {
            await update(ref(db, 'members/'+id), { status: curStatus === 'frozen' ? 'active' : 'frozen' });
        },
        openChat: (id) => { core.activeId = id; user.init(); document.getElementById('userPanel').style.display='block'; }
    };

    window.user = {
        init: () => {
            document.getElementById('userPanel').style.display='block';
            onValue(ref(db, 'members/'+core.activeId), (snap) => {
                const m = snap.val(); if(!m) return;
                const days = Math.floor((new Date(m.expiryDate) - new Date()) / (1000*60*60*24));
                
                document.getElementById('u_countdown').innerText = Math.max(0, days);
                document.getElementById('u_expiry').innerText = "ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: " + new Date(m.expiryDate).toLocaleDateString('ar-EG');
                document.getElementById('frozenOverlay').style.display = m.status === 'frozen' ? 'flex' : 'none';
                
                document.getElementById('u_disp_cal').innerText = m.calories || 0;
                document.getElementById('u_disp_pro').innerText = m.protein || 0;
                document.getElementById('u_view_bf').innerText = m.breakfast || '---';
                document.getElementById('u_view_lun').innerText = m.lunch || '---';
                document.getElementById('u_view_din').innerText = m.dinner || '---';
                document.getElementById('u_view_work').innerText = m.workout || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„...';

                const lastH = (m.history || []).slice(-1)[0] || {};
                ['weight','waist','belly','hips','thigh','arm','chest'].forEach(k => {
                    const el = document.getElementById('m_'+k);
                    if(el) el.value = lastH[k] || '';
                });

                user.drawChart(m.history || []);

                const cBox = document.getElementById('chatBox');
                cBox.innerHTML = (m.chat || []).map((msg, i) => `
                    <div class="msg ${msg.s}">
                        <div>${msg.t}</div>
                        <div class="msg-tools">
                            <span onclick="chat.editMsg(${i})"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</span>
                            <span onclick="chat.delMsg(${i})" style="color:var(--danger)"><i class="fas fa-trash"></i> Ø­Ø°Ù</span>
                        </div>
                    </div>`).join('');
                cBox.scrollTop = cBox.scrollHeight;
            });
        },
        saveMeasures: async () => {
            const h = {
                weight: document.getElementById('m_weight').value,
                waist: document.getElementById('m_waist').value,
                belly: document.getElementById('m_belly').value,
                hips: document.getElementById('m_hips').value,
                thigh: document.getElementById('m_thigh').value,
                arm: document.getElementById('m_arm').value,
                chest: document.getElementById('m_chest').value,
                date: new Date().toLocaleDateString('ar-EG', {month:'short', day:'numeric'})
            };
            const s = await get(ref(db, 'members/'+core.activeId));
            const history = s.val().history || [];
            history.push(h);
            await update(ref(db, 'members/'+core.activeId), { history: history });
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠØ§Ø³Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!');
        },
        drawChart: (data) => {
            const ctx = document.getElementById('weightChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'ØªØ·ÙˆØ± Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)',
                        data: data.map(d => d.weight),
                        borderColor: '#ffcc33',
                        backgroundColor: 'rgba(255, 204, 51, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { display: false }, ticks: { color: '#fff' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    };

    window.chat = {
        send: async () => {
            const t = document.getElementById('chatInp').value; if(!t) return;
            const s = await get(ref(db, 'members/'+core.activeId));
            const c = s.val().chat || [];
            c.push({ s: core.role==='admin'?'cap':'user', t });
            await update(ref(db, 'members/'+core.activeId), { chat: c });
            document.getElementById('chatInp').value = '';
        },
        delMsg: async (i) => {
            if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
            const s = await get(ref(db, 'members/'+core.activeId));
            let c = s.val().chat || []; c.splice(i, 1);
            await update(ref(db, 'members/'+core.activeId), { chat: c });
        },
        editMsg: async (i) => {
            const s = await get(ref(db, 'members/'+core.activeId));
            let c = s.val().chat || [];
            const nt = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', c[i].t);
            if(nt !== null) { c[i].t = nt; await update(ref(db, 'members/'+core.activeId), { chat: c }); }
        }
    };

    // --- Ø§Ù„Ø®Ø·ÙˆØ© Ø±Ù‚Ù… 3: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker Ù„Ù€ PWA ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Power Gym PWA: Service Worker Registered'))
          .catch(err => console.log('Power Gym PWA: Registration Failed', err));
      });
    }
</script>
</body>
</html>

