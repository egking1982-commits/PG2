<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Gym | Captain Rehab V23</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root { --gold: #d4af37; --navy: #0a0e17; --glass: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.1); --success: #00ff88; --danger: #ff4d4d; }
        body { font-family: 'Cairo', sans-serif; background: var(--navy); color: #fff; margin: 0; }
        header { padding: 15px 5%; background: rgba(10, 14, 23, 0.95); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .p-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .p-input { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: white; width: 100%; margin-bottom: 12px; font-family: 'Cairo'; box-sizing: border-box; }
        .p-btn { background: var(--gold); color: #000; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .chat-box { height: 350px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .msg.cap { background: var(--gold); color: #000; align-self: flex-start; }
        .msg.user { background: rgba(255,255,255,0.1); align-self: flex-end; }
        .measure-img { width: 100%; max-width: 350px; border-radius: 15px; border: 1px solid var(--gold); margin: 10px auto; display: block; }
        .rec-active { background: var(--danger) !important; color: #fff !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: center; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; justify-content:center; align-items:center; }
        .modal-content { background:var(--navy); width:90%; max-width:500px; padding:25px; border-radius:20px; border:1px solid var(--gold); }
        .tip-box { border-right: 4px solid var(--gold); background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="p-card" style="width: 320px; margin: 100px auto; text-align: center;">
            <h2 style="color: var(--gold);">POWER GYM</h2>
            <select id="loginRole" class="p-input"><option value="user">Ø¯Ø®ÙˆÙ„ Ø¨Ø·Ù„Ø©</option><option value="admin">Ù„ÙˆØ­Ø© Ø§Ù„ÙƒØ§Ø¨ØªÙ†</option></select>
            <input type="text" id="uInp" class="p-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="pInp" class="p-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="p-btn" style="width:100%" onclick="core.login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <header><span id="navUserName" style="font-weight:900; color:var(--gold)"></span><button onclick="location.reload()" class="p-btn" style="background:var(--danger); color:#fff">Ø®Ø±ÙˆØ¬</button></header>
        
        <div class="container">
            <div id="adminPanel" style="display: none;">
                <div class="p-card">
                    <h3>ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø¨Ø·Ù„Ø§Øª</h3>
                    <select id="memberSelector" class="p-input" onchange="admin.loadData(this.value)"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ù„Ø©</option></select>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px">
                        <input type="number" id="cw" class="p-input" placeholder="Ø§Ù„ÙˆØ²Ù†">
                        <input type="number" id="ch" class="p-input" placeholder="Ø§Ù„Ø·ÙˆÙ„">
                        <input type="number" id="ca" class="p-input" placeholder="Ø§Ù„Ø¹Ù…Ø±">
                    </div>
                    <button class="p-btn" onclick="admin.calculate()">Ø§Ø­Ø³Ø¨ÙŠ Ø§Ù„Ø¢Ù†</button>
                    <div id="adminCalcRes" style="margin-top:10px; color:var(--success); font-weight:bold"></div>
                </div>
                <div class="p-card"><h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ§Øª</h3><div style="overflow-x:auto"><table><thead><tr><th>Ø§Ù„Ø¨Ø·Ù„Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¯Ø§Ø±Ø©</th></tr></thead><tbody id="adminTable"></tbody></table></div></div>
            </div>

            <div id="userPanel" style="display: none;">
                <div style="display:grid; grid-template-columns: 1.6fr 1fr; gap:20px" class="user-grid">
                    <div>
                        <div class="p-card" style="text-align:center">
                            <h2 id="uCalDisp" style="color:var(--success); font-size:3rem; margin:0">0</h2><p>Ø³Ø¹Ø±Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                            <div id="tipContainer" class="tip-box"></div>
                        </div>
                        <div class="p-card">
                            <h3><i class="fas fa-ruler-combined"></i> ØªØ­Ø¯ÙŠØ« Ù…Ù‚Ø§Ø³Ø§ØªÙŠ</h3>
                            <img src="p_3653sbemj0.png" class="measure-img">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                                <input type="number" id="m1" class="p-input" placeholder="Ø§Ù„ÙˆØ²Ù†">
                                <input type="number" id="m2" class="p-input" placeholder="Ø§Ù„ØµØ¯Ø±">
                                <input type="number" id="m3" class="p-input" placeholder="Ø§Ù„Ø®ØµØ±">
                                <input type="number" id="m4" class="p-input" placeholder="Ø§Ù„Ø£Ø±Ø¯Ø§Ù">
                                <input type="number" id="m5" class="p-input" placeholder="Ø§Ù„Ø°Ø±Ø§Ø¹">
                                <input type="number" id="m6" class="p-input" placeholder="Ø§Ù„ÙØ®Ø°">
                                <input type="number" id="m7" class="p-input" placeholder="Ø§Ù„Ø±Ù‚Ø¨Ø©">
                            </div>
                            <button class="p-btn" style="width:100%" onclick="user.saveMeasures()">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·ÙˆØ± ğŸ†</button>
                        </div>
                    </div>
                    <div>
                        <div class="p-card">
                            <h3>Ø´Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
                            <div id="chatBox" class="chat-box"></div>
                            <div style="display:flex; gap:5px; margin-top:10px">
                                <button class="p-btn" style="background:#444; padding:10px" id="recBtn" onclick="chat.toggleRec()"><i class="fas fa-microphone"></i></button>
                                <button class="p-btn" style="background:#444; padding:10px" onclick="document.getElementById('fileUp').click()"><i class="fas fa-paperclip"></i></button>
                                <input type="file" id="fileUp" hidden onchange="chat.upload(this)">
                                <input type="text" id="chatMsg" class="p-input" style="margin:0" placeholder="Ø±Ø³Ø§Ù„Ø©..">
                                <button class="p-btn" onclick="chat.send()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal"><div class="modal-content">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ù„Ø©</h3>
        <input type="text" id="edName" class="p-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input type="number" id="edCal" class="p-input" placeholder="Ø§Ù„Ø³Ø¹Ø±Ø§Øª">
        <button class="p-btn" style="width:100%" onclick="admin.saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="p-btn" style="width:100%; margin-top:10px; background:#444" onclick="document.getElementById('editModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC8qS1LqY3Q2P2LmcvM-M3lW9pNBP3o0JU",
        authDomain: "power-gym-c0a65.firebaseapp.com",
        projectId: "power-gym-c0a65",
        storageBucket: "power-gym-c0a65.firebasestorage.app",
        messagingSenderId: "781355588548",
        appId: "1:781355588548:web:0b110ef5b7055731972291",
        databaseURL: "https://power-gym-c0a65-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let mediaRecorder; let audioChunks = []; let isRecording = false;

    window.core = {
        activeId: null, role: 'user',
        login: async function() {
            const u = document.getElementById('uInp').value, p = document.getElementById('pInp').value;
            this.role = document.getElementById('loginRole').value;
            if(this.role === 'admin' && p === 'cap123') this.showUI('admin', {name:'Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø±Ø­Ø§Ø¨'});
            else {
                const snap = await get(ref(db, 'members'));
                const m = Object.values(snap.val()||{}).find(x => x.user === u && x.pass === p);
                if(m) { this.activeId = m.id; this.showUI('user', m); } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
            }
        },
        showUI: (role, data) => {
            document.getElementById('loginPage').style.display='none';
            document.getElementById('mainApp').style.display='block';
            document.getElementById('navUserName').innerText = data.name;
            if(role === 'admin') admin.listen(); else user.listen();
        }
    };

    window.admin = {
        listen: () => {
            document.getElementById('adminPanel').style.display='block';
            onValue(ref(db, 'members'), (snap) => {
                const tbody = document.getElementById('adminTable'); tbody.innerHTML = '';
                const selector = document.getElementById('memberSelector'); selector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ù„Ø©</option>';
                Object.values(snap.val()||{}).forEach(m => {
                    selector.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                    tbody.innerHTML += `<tr><td>${m.name}</td><td>${m.status}</td><td>
                        <i class="fas fa-edit" style="color:var(--gold); cursor:pointer" onclick="admin.openEdit('${m.id}')"></i> |
                        <i class="fas fa-snowflake" style="color:var(--danger); cursor:pointer" onclick="admin.toggle('${m.id}','${m.status}')"></i> |
                        <i class="fas fa-comment" style="color:#0088ff; cursor:pointer" onclick="admin.openChat('${m.id}')"></i>
                    </td></tr>`;
                });
            });
        },
        loadData: async (id) => {
            if(!id) return;
            const s = await get(ref(db, 'members/'+id)); const m = s.val();
            document.getElementById('cw').value = m.measures?.[m.measures.length-1]?.w || 70;
            document.getElementById('ch').value = 160; document.getElementById('ca').value = 25;
        },
        calculate: () => {
            const w = document.getElementById('cw').value, h = document.getElementById('ch').value, a = document.getElementById('ca').value;
            const res = (10 * w) + (6.25 * h) - (5 * a) - 161;
            document.getElementById('adminCalcRes').innerText = `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${Math.round(res * 1.3)} Ø³Ø¹Ø±Ø©`;
        },
        openEdit: async (id) => {
            core.activeId = id; const s = await get(ref(db, 'members/'+id));
            document.getElementById('edName').value = s.val().name;
            document.getElementById('edCal').value = s.val().calories || 0;
            document.getElementById('editModal').style.display='flex';
        },
        saveEdit: () => {
            update(ref(db, 'members/'+core.activeId), { name: document.getElementById('edName').value, calories: document.getElementById('edCal').value });
            document.getElementById('editModal').style.display='none';
        },
        toggle: (id, s) => update(ref(db, 'members/'+id), {status: s==='active'?'frozen':'active'}),
        openChat: (id) => { core.activeId = id; user.listen(); }
    };

    window.user = {
        listen: () => {
            document.getElementById('userPanel').style.display='block';
            onValue(ref(db, 'members/'+core.activeId), (snap) => {
                const m = snap.val(); if(!m) return;
                document.getElementById('uCalDisp').innerText = m.calories || '0';
                const tips = ["Ø§Ø´Ø±Ø¨ÙŠ 3 Ù„ØªØ± Ù…Ø§Ø¡ ÙŠÙˆÙ…ÙŠØ§Ù‹", "Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ù‡Ùˆ Ø³Ø± Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", "Ø§Ù„Ù†ÙˆÙ… Ø§Ù„ÙƒØ§ÙÙŠ ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ´ÙØ§Ø¡", "Ø§Ù„ØªØ²Ù…ÙŠ Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª"];
                document.getElementById('tipContainer').innerText = "Ù†ØµÙŠØ­Ø© Ø§Ù„ÙŠÙˆÙ…: " + tips[Math.floor(Math.random()*tips.length)];
                document.getElementById('chatBox').innerHTML = (m.chat || []).map(msg => `
                    <div class="msg ${msg.s}">
                        ${msg.t ? `<div>${msg.t}</div>` : ''}
                        ${msg.file ? (msg.type.includes('image') ? `<img src="${msg.file}">` : `<video controls src="${msg.file}"></video>`) : ''}
                        ${msg.audio ? `<audio controls src="${msg.audio}"></audio>` : ''}
                    </div>`).join('');
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            });
        },
        saveMeasures: async () => {
            const s = await get(ref(db, 'members/'+core.activeId)); const m = s.val();
            const ms = m.measures || [];
            ms.push({ w:document.getElementById('m1').value, date:new Date().toLocaleDateString() });
            update(ref(db, 'members/'+core.activeId), {measures: ms, points: (m.points||0)+10});
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸!');
        }
    };

    window.chat = {
        toggleRec: async () => {
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const s = await get(ref(db, `members/${core.activeId}/chat`)); const c = s.val() || [];
                        c.push({s: core.role==='admin'?'cap':'user', audio: reader.result});
                        update(ref(db, 'members/'+core.activeId), {chat: c});
                    };
                    reader.readAsDataURL(blob);
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recBtn').classList.add('rec-active');
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recBtn').classList.remove('rec-active');
            }
        },
        send: async () => {
            const txt = document.getElementById('chatMsg').value; if(!txt) return;
            const s = await get(ref(db, `members/${core.activeId}/chat`)); const c = s.val() || [];
            c.push({s: core.role==='admin'?'cap':'user', t: txt});
            update(ref(db, 'members/'+core.activeId), {chat: c});
            document.getElementById('chatMsg').value = '';
        },
        upload: (el) => {
            const file = el.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const s = await get(ref(db, `members/${core.activeId}/chat`)); const c = s.val() || [];
                c.push({s: core.role==='admin'?'cap':'user', file: e.target.result, type: file.type});
                update(ref(db, 'members/'+core.activeId), {chat: c});
            };
            reader.readAsDataURL(file);
        }
    };
</script>
</body>
</html>
